#include "msp430g2553.h"
#include "lcd.h"

static const unsigned LCD_RESET = 	BIT0;    // PORT2
static const unsigned LCD_CE = 		BIT1;    // PORT2
static const unsigned LCD_DC = 		BIT2;    // PORT2
static const unsigned LCD_DATA = 	BIT3;    // PORT2
static const unsigned LCD_CLK = 	BIT4;    
static const unsigned LCD_BACKLIGHT =   BIT5;


void lcd_send(const unsigned char *cmd, unsigned len, const lcd_cmd_type type)
{
    register unsigned mask;
    
    P2OUT &= ~LCD_CE;
    do {
        mask = 0x0080;
        do {
            if(*cmd & mask) {
                P2OUT &= ~LCD_CLK;
                P2OUT |= LCD_DATA;
            } else {
                P2OUT &= ~(LCD_CLK | LCD_DATA);
            }
            P2OUT |= LCD_CLK;
            mask >>= 1;
        } while(!(mask & 1));
        if(!type) P2OUT &= ~LCD_DC;
        if(*cmd & mask) {
            P2OUT &= ~LCD_CLK;
            P2OUT |= LCD_DATA;
        } else {
            P2OUT &= ~(LCD_CLK | LCD_DATA);
        }
        P2OUT |= LCD_CLK;
        P2OUT |= LCD_DC;
        if(!(type & 2)) ++cmd;
    } while(--len);
    P2OUT |= LCD_CE;
}

static const unsigned char home[] = { 0x40, 0x80 };

void lcd_home(void)
{
    lcd_send(home, sizeof(home), lcd_command);
}

void lcd_pos(unsigned char x, unsigned char y)
{
    unsigned char c[2];
    c[0] = 0x80 | x;
    c[1] = 0x40 | y;
    lcd_send(c, sizeof(c), lcd_command);
}

void lcd_clear(unsigned char x)
{
    lcd_home();
    lcd_send(&x, 504, lcd_data_repeat);
    lcd_home();
}

void lcd_init(void)
{
    static const unsigned char init[] = {
        0x20 + 0x01,    // Function set - extended instructions enabled
        //0x80 + 64,    // Set vop (contrast) 0 - 127
        0x80 + 66,      // This is better for fast LCD update
        0x04 + 0x02,    // Temperature control
        0x10 + 0x03,    // Set bias system
        0x20 + 0x00,    // Function set - chip active, horizontal addressing, basic instructions
        0x08 + 0x04     // Display control - normal mode
    };
    
    P2REN = 0;
    P2DIR = LCD_DC | LCD_CE | LCD_CLK | LCD_BACKLIGHT | LCD_DATA | LCD_RESET;
    P2OUT = LCD_CE | LCD_CLK | LCD_RESET;
    
    __delay_cycles(20000);
    P2OUT |= LCD_DC;
    __delay_cycles(20000);

    lcd_send(init, sizeof(init), lcd_command);
}

static const unsigned char font6x8[96][5] = {
    0x00, 0x00, 0x00, 0x00, 0x00, // 20  32   <space>
    0x00, 0x00, 0x5F, 0x00, 0x00, // 21  33   !
    0x00, 0x07, 0x00, 0x07, 0x00, // 22  34   "
    0x14, 0x7F, 0x14, 0x7F, 0x14, // 23  35   #
    0x24, 0x2A, 0x7F, 0x2A, 0x12, // 24  36   $
    0x23, 0x13, 0x08, 0x64, 0x62, // 25  37   %
    0x36, 0x49, 0x56, 0x20, 0x50, // 26  38   &
    0x00, 0x08, 0x07, 0x03, 0x00, // 27  39   '
    0x00, 0x1C, 0x22, 0x41, 0x00, // 28  40   (
    0x00, 0x41, 0x22, 0x1C, 0x00, // 29  41   )
    0x2A, 0x1C, 0x7F, 0x1C, 0x2A, // 2A  42   *
    0x08, 0x08, 0x3E, 0x08, 0x08, // 2B  43   +
    0x00, 0x40, 0x38, 0x18, 0x00, // 2C  44   ,
    0x08, 0x08, 0x08, 0x08, 0x08, // 2D  45   -
    0x00, 0x00, 0x60, 0x60, 0x00, // 2E  46   .
    0x20, 0x10, 0x08, 0x04, 0x02, // 2F  47   /
    0x3E, 0x51, 0x49, 0x45, 0x3E, // 30  48   0
    0x00, 0x42, 0x7F, 0x40, 0x00, // 31  49   1
    0x42, 0x61, 0x51, 0x49, 0x46, // 32  50   2
    0x21, 0x41, 0x49, 0x4D, 0x33, // 33  51   3
    0x18, 0x14, 0x12, 0x7F, 0x10, // 34  52   4
    0x27, 0x45, 0x45, 0x45, 0x39, // 35  53   5
    0x3C, 0x4A, 0x49, 0x49, 0x30, // 36  54   6
    0x41, 0x21, 0x11, 0x09, 0x07, // 37  55   7
    0x36, 0x49, 0x49, 0x49, 0x36, // 38  56   8
    0x06, 0x49, 0x49, 0x29, 0x1E, // 39  57   9
    0x00, 0x00, 0x14, 0x00, 0x00, // 3A  58   :
    0x00, 0x00, 0x40, 0x34, 0x00, // 3B  59   ;
    0x00, 0x08, 0x14, 0x22, 0x41, // 3C  60   <
    0x14, 0x14, 0x14, 0x14, 0x14, // 3D  61   =
    0x00, 0x41, 0x22, 0x14, 0x08, // 3E  62   >
    0x02, 0x01, 0x51, 0x09, 0x06, // 3F  63   ?
    0x3E, 0x41, 0x5D, 0x59, 0x4E, // 40  64   @
    0x7C, 0x12, 0x11, 0x12, 0x7C, // 41  65   A
    0x7F, 0x49, 0x49, 0x49, 0x36, // 42  66   B
    0x3E, 0x41, 0x41, 0x41, 0x22, // 43  67   C
    0x7F, 0x41, 0x41, 0x41, 0x3E, // 44  68   D
    0x7F, 0x49, 0x49, 0x49, 0x41, // 45  69   E
    0x7F, 0x09, 0x09, 0x09, 0x01, // 46  70   F
    0x3E, 0x41, 0x49, 0x49, 0x7A, // 47  71   G
    0x7F, 0x08, 0x08, 0x08, 0x7F, // 48  72   H
    0x00, 0x41, 0x7F, 0x41, 0x00, // 49  73   I
    0x20, 0x40, 0x41, 0x3F, 0x01, // 4A  74   J
    0x7F, 0x08, 0x14, 0x22, 0x41, // 4B  75   K
    0x7F, 0x40, 0x40, 0x40, 0x40, // 4C  76   L
    0x7F, 0x02, 0x1C, 0x02, 0x7F, // 4D  77   M
    0x7F, 0x04, 0x08, 0x10, 0x7F, // 4E  78   N
    0x3E, 0x41, 0x41, 0x41, 0x3E, // 4F  79   O
    0x7F, 0x09, 0x09, 0x09, 0x06, // 50  80   P
    0x3E, 0x41, 0x51, 0x21, 0x5E, // 51  81   Q
    0x7F, 0x09, 0x19, 0x29, 0x46, // 52  82   R
    0x26, 0x49, 0x49, 0x49, 0x32, // 53  83   S
    0x01, 0x01, 0x7F, 0x01, 0x01, // 54  84   T
    0x3F, 0x40, 0x40, 0x40, 0x3F, // 55  85   U
    0x1F, 0x20, 0x40, 0x20, 0x1F, // 56  86   V
    0x3F, 0x40, 0x38, 0x40, 0x3F, // 57  87   W
    0x63, 0x14, 0x08, 0x14, 0x63, // 58  88   X
    0x03, 0x04, 0x78, 0x04, 0x03, // 59  89   Y
    0x61, 0x51, 0x49, 0x45, 0x43, // 5A  90   Z
    0x00, 0x7F, 0x41, 0x41, 0x41, // 5B  91   [
    0x02, 0x04, 0x08, 0x10, 0x20, // 5C  92   '\'
    0x00, 0x41, 0x41, 0x41, 0x7F, // 5D  93   ]
    0x04, 0x02, 0x01, 0x02, 0x04, // 5E  94   ^
    0x80, 0x80, 0x80, 0x80, 0x80, // 5F  95   _
    0x00, 0x03, 0x07, 0x08, 0x00, // 60  96   '
    0x20, 0x54, 0x54, 0x54, 0x78, // 61  97   a
    0x7F, 0x28, 0x44, 0x44, 0x38, // 62  98   b
    0x38, 0x44, 0x44, 0x44, 0x28, // 63  99   c
    0x38, 0x44, 0x44, 0x28, 0x7F, // 64  100  d
    0x38, 0x54, 0x54, 0x54, 0x18, // 65  101  e
    0x00, 0x08, 0x7E, 0x09, 0x02, // 66  102  f
    0x18, 0xA4, 0xA4, 0xA4, 0x7C, // 67  103  g
    0x7F, 0x08, 0x04, 0x04, 0x78, // 68  104  h
    0x00, 0x44, 0x7D, 0x40, 0x00, // 69  105  i
    0x00, 0x20, 0x40, 0x40, 0x3D, // 6A  106  j
    0x00, 0x7F, 0x10, 0x28, 0x44, // 6B  107  k
    0x00, 0x41, 0x7F, 0x40, 0x00, // 6C  108  l
    0x7C, 0x04, 0x78, 0x04, 0x78, // 6D  109  m
    0x7C, 0x08, 0x04, 0x04, 0x78, // 6E  110  n
    0x38, 0x44, 0x44, 0x44, 0x38, // 6F  111  o
    0xFC, 0x18, 0x24, 0x24, 0x18, // 70  112  p
    0x18, 0x24, 0x24, 0x18, 0xFC, // 71  113  q
    0x7C, 0x08, 0x04, 0x04, 0x08, // 72  114  r
    0x48, 0x54, 0x54, 0x54, 0x24, // 73  115  s
    0x04, 0x04, 0x3F, 0x44, 0x24, // 74  116  t
    0x3C, 0x40, 0x40, 0x20, 0x7C, // 75  117  u
    0x1C, 0x20, 0x40, 0x20, 0x1C, // 76  118  v
    0x3C, 0x40, 0x30, 0x40, 0x3C, // 77  119  w
    0x44, 0x28, 0x10, 0x28, 0x44, // 78  120  x
    0x4C, 0x90, 0x90, 0x90, 0x7C, // 79  121  y
    0x44, 0x64, 0x54, 0x4C, 0x44, // 7A  122  z
    0x00, 0x08, 0x36, 0x41, 0x00, // 7B  123  {
    0x00, 0x00, 0x77, 0x00, 0x00, // 7C  124  |
    0x00, 0x41, 0x36, 0x08, 0x00, // 7D  125  }
    0x02, 0x01, 0x02, 0x04, 0x02, // 7E  126  ~
    0x00, 0x06, 0x09, 0x09, 0x06, // 7F  127 degrees
};

void lcd_print(char *s, unsigned x, unsigned y)
{
    lcd_pos(x, y);
    while(*s) {
        lcd_send(&font6x8[*s - 32][0], 5, lcd_data);
        lcd_send(&font6x8[0][0], 1, lcd_data);
        ++s;
    }
}

void lcd_character(char s, unsigned x, unsigned y)
{

		if (s==0x0D || s=='\0')
			s=0x20;

        lcd_send(&font6x8[s - 32][0], 5, lcd_data);
        lcd_send(&font6x8[0][0], 1, lcd_data);
}


static const unsigned char num10x16[12][9 * 2] = {      // Numbers for 10x16 cell
    0xF0,0xF8,0x0C,0x04,0x04,0x04,0x0C,0xF8,0xF0, // 0
    0x0F,0x1F,0x30,0x20,0x20,0x20,0x30,0x1F,0x0F,
    0x00,0x00,0x10,0x10,0xFC,0xFC,0x00,0x00,0x00, // 1
    0x00,0x00,0x20,0x20,0x3F,0x3F,0x20,0x20,0x00,
    0x18,0x1C,0x04,0x04,0x04,0x04,0x8C,0xF8,0x70, // 2
    0x20,0x30,0x38,0x2C,0x26,0x23,0x21,0x20,0x20,
    0x18,0x1C,0x04,0x84,0x84,0x84,0xCC,0x78,0x30, // 3
    0x18,0x38,0x20,0x20,0x20,0x20,0x31,0x1F,0x0E,
    0x00,0x80,0x40,0x20,0x10,0x08,0xFC,0xFC,0x00, // 4
    0x03,0x02,0x02,0x02,0x02,0x02,0x3F,0x3F,0x02,
    0x00,0x7C,0x7C,0x44,0x44,0x44,0xC4,0x84,0x04, // 5
    0x18,0x38,0x20,0x20,0x20,0x20,0x30,0x1F,0x0F,
    0xE0,0xF0,0x58,0x4C,0x44,0x44,0xC4,0x84,0x00, // 6
    0x0F,0x1F,0x30,0x20,0x20,0x20,0x30,0x1F,0x0F,
    0x04,0x04,0x04,0x04,0x04,0xC4,0xF4,0x3C,0x0C, // 7
    0x00,0x00,0x30,0x3C,0x0F,0x03,0x00,0x00,0x00,
    0x30,0x78,0xCC,0x84,0x84,0x84,0xCC,0x78,0x30, // 8
    0x0E,0x1F,0x31,0x20,0x20,0x20,0x31,0x1F,0x0E,
    0xF0,0xF8,0x0C,0x04,0x04,0x04,0x0C,0xF8,0xF0, // 9
    0x00,0x21,0x23,0x22,0x22,0x32,0x1A,0x0F,0x07,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // <space>
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0xF0,  // punto
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x0F
};

void lcd_pd10(unsigned n, unsigned x, unsigned y)       // Print 10x16 digit
{
    unsigned char c[2];
    c[0] = 0x80 | x;
    c[1] = 0x40 + y; lcd_send(c, 2, lcd_command);   lcd_send(num10x16[n], 9, lcd_data);
    c[1] = 0x41 + y; lcd_send(c, 2, lcd_command);   lcd_send(num10x16[n] + 9, 9, lcd_data);
}

void print_int(unsigned long n, unsigned char fila)
{
    const unsigned long *dp = dv;
    unsigned x = 0;
    unsigned c;
    unsigned long d;

    while(n < *dp) {                            // Skip leading zeros
        if(*dp == 100000 || *dp == 100) x += 2; // Space between 3 digit groups
        ++dp;                                   //
        lcd_pd10(10, x, fila);                     // Print space
        x += 10;                                //
    }                                           //
    if(n) {                                     // Non-zero
        do {                                    //
            d = *dp++;                          // Get digit value
            c = 0;                              //
            while(n >= d) ++c, n -= d;          // Divide
            if(d == 100000 || d == 100) x += 2; // Space between 3 digit groups
            lcd_pd10(c, x, fila);                  // Print digit
            x += 10;                            //
        } while(!(d & 1));                      // Until all digits done
    } else                                      //
        lcd_pd10(0, x - 10, fila);                 // Print zero
}
